# 並查集

並查集是一種樹狀結構，他支援兩件事

- 查詢所隸屬集合
- 合併兩個集合

我們把集合轉化成樹，一顆樹代表一個集合，樹根代表集合的老大，查詢隸屬集合就回傳樹根是誰（一個樹餔可能有兩顆樹根吧），合併的時侯，就把一顆樹的樹根只到另一顆，以下為詳細的描述。

## 初始

一開始的時候，每個點自成一個集合，所以把樹根都設為自己。

## 查詢

查詢的時候，要查到樹根為自己的點，為止否則的話就要繼續查。

```cpp
--8<-- "docs/graph/code/djs1.cpp"
```

狀態壓縮：在合併之後原本被指向的樹根就沒用了，我們可以一邊做查詢時，一邊做更新。

```cpp
--8<-- "docs/graph/code/djs2.cpp"
```

![](images/disjointsetFind.gif)

## 合併
找出兩個點的樹根，將一個樹根合併指到另一個樹根。

```cpp
--8<-- "docs/graph/code/djs3.cpp"
```

![](images/disjointsetUnion.gif)

啟發式合併：建立一個 $h[i]$ 代表樹的高度，亦是元素最大遞迴次數， $h[i]$ 一開始為 $1$ 。再來，我們每次都讓高度小的高度大的合併，如果遇到高度一樣的，就讓合併別人的樹高度加 $1$ 。如果要把高度變為 $x$ ，則至少需要 $2^x$ 個點，由此推出 N 個點所形成最高之高度為 $\log(N)$ 。

```cpp
--8<-- "docs/graph/code/djs4.cpp"
```

也可以維護並查集的個數，個數大的合併個數小的並查集。

```cpp
--8<-- "docs/graph/code/djs5.cpp"
```

## 完整程式碼

```cpp
--8<-- "docs/graph/code/djs6.cpp"
```

## 相關題目

???+ Question "UVa 10608 - Friends"
    給定 $N$ 個人的朋友關係，如果兩個人是朋友，他們在同一個朋友圈，問有幾個人在最大的朋友圈。

???+ Question "UVa 11503 - Virtual Friends"
    給定 $N$ 個人的朋友關係，如果兩個人是朋友，問兩個人成為新朋友，他們的朋友圈總共有幾個人。

這兩題題目相似，都要維護每個集合的個數，最後答案會根據每個集合的數量計算出來。

UVa 10608 這題需要注意最大的朋友圈可能不只一個，如果有多個集合大小一樣，需要累加答案。

UVa 11503 給定朋友的名字，在實作上，會利用 `map` 將名字對應數字再做計算。

???+ Question "UVa 00615 - Is It A Tree?"
    給你數條有向邊，判斷是否為一顆樹?

有向樹有幾個條件：

- 只有一個入度 $=0$ 的點，其他都是入度 $=1$ 的點。
- 是連通圖且無環。

第二項條件可以用並查集或 DFS 判斷。

## 帶權並查集

在並查集上增加數值，數值會在查詢的時候更新，讓並查集能解決更多問題。

更新原則：我到根節點的距離=我到父節點的距離+父節點到根節點的距離。

```cpp
--8<-- "docs/graph/code/wdjs.cpp"
```

???+ Question "UVa 01329 - Corporative Network"
    給定 $N$ 個節點和兩種操作，一開始每個點都沒有父節點。
    - `E x`: 輸出 `x` 到根節點的距離。
    - `I x y`: 將 `x` 的父節點設為 `y`，距離為 $|x-y|\ \mod 1000$。

## 帶刪除並查集

刪除操作是指將特定點 $u$ 從當前集合移除，自己獨立一個集合或是加入新的集合，實作步驟如下：

- 開一個陣列 $id$ 維護每個點的編號。
    - 查詢 $x$: `Find(id[x])`。
    - 合併 $x,y$: `Union(id[x],id[y])`。
- 將 $u$ 從當前集合移除
    - 扣除 $u$ 在原本集合的貢獻。
    - 為 $id[u]$ 產生新的編號。
    - 保留舊編號，否則會影響 $u$ 原本的子節點。


???+ Question "UVa 11987 - Almost Union-Find"
    給定 $N$ 個點和 $M$ 筆操作，一開始每個點都是自己一個集合，操作有三種：
    - `1 p q`: 將 $p,q$ 所在的集合合併。
    - `2 p q`: 將 $p$ 和 $q$ 所在的集合合併。
    - `3 p`: 詢問 $p$ 所在的集合元素個數和總和。

??? "參考程式碼"

    ```cpp
    --8<-- "docs/graph/code/uva11987.cpp"
    ```
